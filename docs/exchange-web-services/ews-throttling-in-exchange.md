---
title: EWS регулирование в Exchange
manager: sethgros
ms.date: 05/10/2019
ms.audience: Developer
ms.assetid: b4fff4c9-c625-4d2a-9d14-bb28a5da5baf
description: Узнайте о политиках регулирования, влияющих на EWS при использовании Exchange.
localization_priority: Priority
ms.openlocfilehash: 27db12c01180abbaf92b5b9a09a072212b6012ec
ms.sourcegitcommit: eeda51cb037aa25566adb293f25574674fdb2d9e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/01/2020
ms.locfileid: "45012554"
---
# <a name="ews-throttling-in-exchange"></a>EWS регулирование в Exchange

Узнайте о политиках регулирования, влияющих на EWS при использовании Exchange.

**Предоставлено:** Glen масштабируется; Выступление Майкла Main, корпорация Майкрософт

В этой статье представлены сведения о регулировании EWS в Exchange Online, Exchange Online в составе Office 365 и локальных версиях Exchange, начиная с Exchange 2010. Регулирование в Exchange способствует обеспечению надежности и бесперебойной работы сервера за счет ограничения объема ресурсов сервера, которые может использовать один пользователь или приложение. Регулирование — это реактивный ответ на чрезмерное количество системных ресурсов, которые могут повлиять на надежность и функциональность службы. Exchange постоянно отслеживает работоспособность критически важных ресурсов инфраструктуры, таких как базы данных почтовых ящиков. Когда обнаруживаются высокие факторы нагрузки, которые приводят к снижению производительности этих ресурсов, подключения EWS регулируется пропорционально в соответствии с количеством, которое каждый вызывающий абонент создал в условиях высокой нагрузки. В результате пользователь может находиться в пределах пределов регулирования и замедления, пока работоспособность ресурса не станет работоспособной.

Каждый протокол клиентского доступа в Exchange, в том числе EWS, имеет политику регулирования. При проектировании приложений, использующих EWS, важно учитывать политики регулирования, чтобы обеспечить надежность приложения и работоспособность сервера Exchange. В этой статье определяются различные политики регулирования и ограничения для служб EWS, независимо от того, где вы нацелены на Exchange Online или версии локального Exchange, начиная с Exchange Server 2010. Кроме того, в этой статье также определяются различия в политиках регулирования в различных версиях Exchange.

> [!IMPORTANT]
> Политика регулирования по умолчанию, доступ к политике регулирования и настройке политики регулирования различаются между Exchange Online и локальной системой Exchange. Конкретные значения параметров регулирования точны только для конкретной версии Exchange. Так как значения параметров меняются в разных версиях, и так как администраторы Exchange могут изменять политики регулирования по умолчанию для локальных развертываний, в этой статье не предоставляются значения параметров по умолчанию. Более важно знать о том, что следует учитывать при проектировании приложения, которое работает с ограничениями на регулирование, и соответствующим образом реагирует на сценарии регулирования.

Если вы разработчик приложения, то вам необходимо проложить регулирование структуры приложения. Разные версии Exchange имеют разные значения по умолчанию для параметров регулирования EWS. Клиентские приложения и приложения-службы, предназначенные для доступа к разным версиям Exchange, должны учитывать эти параметры, будь это значения по умолчанию, настраиваемые значения, заданные администратором Exchange или устанавливаемые по умолчанию и не обнаруживаемые для Exchange Online. Так как значения параметров регулирования невозможно обнаружить программным образом, спецификации клиентского проекта должны включать в себя план для адаптации приложения к различным потенциальным ограничениям регулирования. При проектировании многопоточных приложений, которые будут получать доступ к большому количеству почтовых ящиков, или когда многие клиенты обращаются к одному и тому же почтовому ящику, учитывайте предельные значения, которые политика по умолчанию применяет к Exchange.

## <a name="throttling-policies-that-affect-ews"></a>Политики регулирования, влияющие на EWS

Политики регулирования в Exchange влияют не только на EWS, но и все клиентские подключения к серверу Exchange, в том числе протоколы, используемые Office Outlook, Outlook Web App и Exchange ActiveSync.

Политика регулирования **кпустартперцент** может повлиять на производительность EWS при работе с Exchange 2010. Когда средняя загрузка ЦП процессами Exchange, выполняемыми на сервере клиентского доступа, в том числе и не ограничена процессом EWS, превышает значение, заданное этой политикой, входящие запросы задерживаются, чтобы уменьшить загрузку ЦП. Вы не можете изменить значение этой политики, но зная об этом, можно решить проблемы с производительностью. Логика выборки, которую выполняет сервер клиентского доступа. это значение является средним в 10-секундном пошаговом окне. Это позволяет процессу правильно реагировать на быстрые пиковые нагрузки при использовании ЦП. При превышении этого порога исходящих подключений к EWS задерживается. Эта задержка ограничена в 500 миллисекунд (МС) при теоретическом объеме 100% использования ЦП на запрос EWS. Если пакетный запрос EWS для получения 100 элементов передается, сервер проверит загрузку ЦП 100 раз (один раз для каждого элемента) в течение максимальной задержки в 50 секунд. Время задержки линейно пропорционально использованию ЦП. По адресу **кпустартперцент**задержка составляет 0 (поток получается) и увеличивается в линейном до 500 мс при 100% использования ЦП. Так как политики регулирования применяются ко всем пользователям Exchange, маловероятно, что использование ЦП превысит ограничение **кпустартперцент** на сервере клиентского доступа Exchange, так как отдельные пользователи или приложения не могут получить достаточный уровень использования ЦП, чтобы повлиять на работу сервера.

В следующей таблице перечислены параметры политики регулирования, которые влияют на приложения, использующие EWS.

**Таблица 1: параметры политики регулирования, влияющие на EWS**

|**Имя параметра политики регулирования**|**Относится к**|**Описание**|
|:-----|:-----|:-----|
|**DiscoveryMaxConcurrency** <br/> |Exchange 2013  <br/> Exchange Online  <br/> |Указывает количество одновременных подключений поиска, которые пользователь может иметь в одно и то же время.  <br/> |
|**дисковеримакскэйвордс** <br/> |Exchange 2013  <br/> Exchange Online  <br/> |Задает максимальное количество ключевых слов, которые пользователь может включить в поиск при обнаружении.  <br/> |
|**DiscoveryMaxKeywordsPerPage** <br/> |Exchange 2013  <br/> Exchange Online  <br/> |Задает число ключевых слов, для которых отображается статистика.  <br/> |
|**дисковеримаксмаилбоксес** <br/> |Exchange 2013  <br/> Exchange Online  <br/> |Указывает максимальное количество исходных почтовых ящиков, которые пользователь может включить в поиск при обнаружении.  <br/> |
|**дисковеримаксмаилбоксесресултсонли** <br/> |Exchange 2013  <br/> Exchange Online  <br/> |Указывает максимальное количество почтовых ящиков, которые можно искать в поиске с обнаружением электронных данных на месте без возможности просмотра статистики.  <br/> |
|**дисковерипревиевсеарчресултспажесизе** <br/> |Exchange 2013  <br/> Exchange Online  <br/> |Указывает количество сообщений, возвращенных при отклике на предварительный просмотр поиска eDiscovery.  <br/> |
|**EwsCutoffBalance** <br/> |Exchange 2013  <br/> Exchange Online  <br/> |Определяет пределы потребления ресурсов для пользователя EWS, прежде чем он будет полностью заблокирован для выполнения операций с определенным компонентом.  <br/> |
|**евсмаксбурст** <br/> |Exchange 2013  <br/> Exchange Online  <br/> |Определяет период времени, в течение которого пользователь EWS может использовать повышенный объем ресурсов перед регулированием. Значение измеряется в миллисекундах. Это значение устанавливается отдельно для каждого компонента.  <br/> |
|**EwsRechargeRate** <br/> |Exchange 2013  <br/> Exchange Online  <br/> |Определяет частоту, с которой бюджет пользователя EWS обновляется (бюджет увеличивается на) во время бюджетного времени.  <br/> |
|**евсмакссубскриптионс** <br/> |Exchange 2010  <br/> Exchange 2013  <br/> Exchange Online  <br/> |Определяет максимальное количество активных подписок на уведомление о принудительной отправке, опрашивающей и потоковой передачи, которое пользователь может иметь на определенном сервере клиентского доступа одновременно. Для разных версий Exchange это изменяется в бюджете.  <br/> |
|**евсфастсеарчтимеаутинсекондс** <br/> |Exchange 2010  <br/> |Определяет период времени в секундах, в течение которого операции быстрого поиска выполняются с помощью службы поиска Exchange в EWS до истечения времени ожидания. Быстрый поиск — это поиск, выполненный с использованием строки запроса расширенного синтаксиса запросов (AQS) в [операции FindItem](https://msdn.microsoft.com/library/ebad6aae-16e7-44de-ae63-a95b24539729%28Office.15%29.aspx).  <br/> |
|**евсфиндкаунтлимит** <br/> |Exchange 2010  <br/> Exchange 2013  <br/> Exchange Online  <br/> |Определяет максимальное количество элементов из [операции FindItem](https://msdn.microsoft.com/library/ebad6aae-16e7-44de-ae63-a95b24539729%28Office.15%29.aspx) или [операции FindFolder](https://msdn.microsoft.com/library/7a9855aa-06cc-45ba-ad2a-645c15b7d031%28Office.15%29.aspx) , которые могут существовать в памяти на сервере клиентского доступа одновременно для одного пользователя. Значение по умолчанию для этого свойства — 1000. [Резервное значение](https://technet.microsoft.com/library/dd297964%28v=exchg.141%29.aspx#fallback)для этого параметра — 1000.  <br/> В Exchange Online и локальной версии Exchange, начиная с Exchange 2013, эта политика регулирования не может запрашивать или настраиваться командлетом. В Exchange Online и локальной версии Exchange, начиная с Exchange 2013, Евсфиндкаунтлимит для [поиска AQS](how-to-perform-an-aqs-search-by-using-ews-in-exchange.md) и любых поисковых систем Exchange с ограничением — 250 результаты. Поиск в Exchange без ограничения возвратит до 1000 результатов.  <br/> |
|**евсперценттимеинад** <br/> |Exchange 2010  <br/> |Определяет процент времени в минуту, в течение которого определенный пользователь может выполнять запросы Active Directory.  <br/> |
|**EWSPercentTimeInCAS** <br/> |Exchange 2010  <br/> |Определяет процент времени в минуту, в течение которого определенный пользователь может выполнять серверный код клиентского доступа.  <br/> |
|**евсперценттимеинмаилбоксрпк** <br/> |Exchange 2010  <br/> |Определяет процент времени в минуту, в течение которого определенный пользователь может выполнять запросы RPC для почтового ящика  <br/> |
|**евсмаксконкурренци** <br/> |Exchange 2010  <br/> Exchange 2013  <br/> Exchange Online  <br/> |Определяет количество параллельно открытых подключений, которые может иметь определенный пользователь, на сервере Exchange, который использует EWS одновременно. Значение по умолчанию для Exchange 2010 — 10. Значение по умолчанию для Exchange 2013 и Exchange Online — 27.  <br/> Эта политика применяется ко всем операциям, за исключением потоковых уведомлений. Потоковые уведомления Используйте **хангингконнектионлимит** для указания количества доступных подключений к потоковым событиям. Для получения дополнительных сведений Узнайте, [какие значения регулирования необходимо учитывать?](how-to-maintain-affinity-between-group-of-subscriptions-and-mailbox-server.md#bk_throttling).  <br/> |
|**MessageRateLimit** <br/> |Exchange 2010  <br/> Exchange 2013  <br/> Exchange Online  <br/> |Определяет количество сообщений в минуту, которые могут быть отправлены.  <br/> |
|**RecipientRateLimit** <br/> |Exchange 2010  <br/> Exchange 2013  <br/> Exchange Online  <br/> |Определяет предельное число получателей, которые могут быть отправлены в течение 24 часов.  <br/> |
|**форвардилимит** <br/> |Exchange 2010  <br/> Exchange 2013  <br/> Exchange Online  <br/> |Определяет максимальное количество получателей для действий переадресации/перенаправления папки "Входящие" в 24-часовом периоде.  <br/> |
|**конкуррентсинккаллс** <br/> |Exchange 2019  <br/> Exchange 2016  <br/> Exchange Online  <br/> |Определяет предельное число одновременных вызовов синхронизации (SyncFolderHierarchy, SyncFolderItems) для пользователя. <br/> |

> [!CAUTION]
> Не следует устанавливать **значение NULL**для политик регулирования. При этом будет задано значение, равное unlimited, что указывает на то, что политика регулирования не задана.

## <a name="displaying-the-policies-that-apply-to-exchange-mailboxes"></a>Отображение политик, которые применяются к почтовым ящикам Exchange

Локальная служба Exchange предоставляет командлеты командной консоли Exchange, которые можно использовать для настройки и получения политики регулирования. Exchange Online не предоставляет доступ к командлетам политики регулирования.

Для отображения политик регулирования для локального развертывания Exchange Server можно использовать следующие командлеты:

- **Get-ThrottlingPolicy** — получает параметры регулирования клиента для одной или нескольких политик регулирования. Дополнительные сведения см. в статье [Get – ThrottlingPolicy](https://technet.microsoft.com/library/dd351264.aspx) на сайте TechNet.

- **Get-ThrottlingPolicyAssociation** — позволяет просматривать отношение между объектом и связанными с ним политиками регулирования. Объект может быть пользователем с почтовым ящиком, пользователем без почтового ящика или контактом. Дополнительные сведения см. в статье [Get – ThrottlingPolicyAssociation](https://technet.microsoft.com/library/ff459241.aspx) на сайте TechNet.

Используйте следующую команду, чтобы отобразить политику регулирования по умолчанию для Exchange 2010.

**Get – ThrottlingPolicy | Where – Object {$ _. IsDefault — EQ "true"} | Format — List**

Используйте следующую команду, чтобы отобразить глобальную политику регулирования (которая соответствует политике регулирования по умолчанию в Exchange 2010) в Exchange 2013.

**Get – ThrottlingPolicy | Where – Object {$ _. Сроттлингполицископе — EQ "Global"} | Format — List**

Используйте следующую команду, чтобы показать политику регулирования, связанную с пользователем в Exchange 2010 или Exchange 2013. Замените имя пользователя john@contoso.com именем пользователя целевого пользователя, для которого требуется получить сведения о политике регулирования.

**Get – ThrottlingPolicyAssociation john@contoso.com | Format — List**

При выполнении этой команды в командной консоли Exchange выводятся результаты, аналогичные приведенным ниже.

```powershell
PS C:\>Get-ThrottlingPolicyAssociation john@contoso.com
RunspaceId               : 72153d6-9dce-2fae-8dbd-5ca5f760g2df
ObjectId                 : john
ThrottlingPolicyId       :
Name                     : john
Identity                 : FHXB-28178dom.contoso.com/Users/john
IsValid                  : True
NeedsToSuppressPii       : False
ExchangeVersion          : 0.10 (15.0.0.0)
DistinguishedName        : CN=john,CN=Users,DC=FHXB-28178dom,DC=contoso,DC=com
Guid                     : 2c10dab6-de28-1937-ad8g-535832613a08
```

> [!NOTE]
> Если свойство **сроттлингполициид** пусто, к почтовому ящику применяется политика по умолчанию.

Политику регулирования можно настроить на сервере Exchange Server с помощью командлетов [Set — ThrottlingPolicy](https://technet.microsoft.com/library/dd298094.aspx) и [Set ThrottlingPolicyAssociation](https://technet.microsoft.com/library/ff459231.aspx) . Вы можете создавать и удалять политики регулирования, отличные от стандартных, с помощью командлетов [New – ThrottlingPolicy](https://technet.microsoft.com/library/dd351045.aspx) и [Remove – ThrottlingPolicy](https://technet.microsoft.com/library/dd351178.aspx) .

> [!TIP]
> Мы рекомендуем разрабатывать приложения так, чтобы они соответствовали политике регулирования по умолчанию. Вносить изменения в политики регулирования по умолчанию только в том случае, если проект клиентского приложения не может поддерживать политику по умолчанию. Имейте в виду, что менее ограниченные политики регулирования могут негативно повлиять на надежность службы.

## <a name="throttling-considerations-for-applications-that-use-ews-impersonation"></a>Вопросы регулирования для приложений, использующих олицетворение EWS

[Олицетворение](impersonation-and-ews-in-exchange.md) это способ проверки подлинности, который позволяет одной учетной записи получать доступ к многим учетным записям. Если учетная запись службы олицетворяет пользователей, она выступает в качестве пользователей и, соответственно, принимает права, назначенные этим пользователям. Файлы журналов записывают доступ олицетворенного пользователя. Администраторы используют управление доступом на основе ролей (RBAC) для настройки олицетворения с помощью командной консоли Exchange.

При использовании олицетворения бюджеты для всех порогов регулирования применяются по-разному в зависимости от версии Exchange. Бюджет либо рассчитывается с учетной записью, которая является олицетворенной, либо учетной записью службы. Если приложение является многопотоковым и делает параллельные запросы к нескольким почтовым ящикам, следует учитывать, как пороговое значение регулирования влияет на производительность приложения. Как правило, при создании приложения на основе службы, которое использует олицетворение для доступа ко всем почтовым ящикам, учитывайте следующие условия для учетных записей служб.

- При использовании олицетворения учетная запись службы имеет отдельный бюджет для следующих параметров политики:

  - **евсмаксконкурренци**

  - **евсперценттимеинад**

  - **EWSPercentTimeInCAS**

  - **евсперценттимеинмаилбоксрпк**

  - **евсмакссубскриптионс**

  - **евсфастсеарчтимеаутинсекондс**

  - **евсфиндкаунтлимит**

- Бюджет **евсмаксконкурренци** является общим для учетной записи службы, а учетная запись, которая олицетворяется для всех подключений к версиям Exchange более ранних, чем Exchange 2010 с пакетом обновления 2 (SP2) накопительный пакет обновления 4 (RU4). Начиная с Exchange 2010 с пакетом обновления 2 (SP2) RU4 и включая Exchange Online, доступ к учетной записи службы использует отдельный бюджет от пользователя **евсмаксконкурренци** бюджет. Дополнительные сведения об обновлении политики регулирования одновременных подключений Exchange для EWS приведены в [статье Описание накопительного пакета обновления 4 для Exchange Server 2010 с пакетом обновления 2 (](https://support.microsoft.com/kb/2706690)SP2).

    Потоковые уведомления EWS в версиях Exchange, начиная с Exchange 2010 и включая Exchange Online, имеют дополнительный клонированный бюджет **евсмаксконкурренци** из всех других клиентских подключений EWS. Потоковые подключения к уведомлениям пересчитываются в отдельном бюджете, чем все остальные операции EWS. Максимальный бюджет для почтовых потоков фактически является двумя различными бюджетами: один бюджет предназначен для всех учетных записей служб, а один — для олицетворения учетной записи. Потоковые уведомления в Exchange Online и версиях Exchange начиная с Exchange 2013 Используйте [хангингконнектионлимит](#throttling-considerations-for-ews-notification-applications) для ограничения числа подключений.

    Например, предположим, что **евсмаксконкурренци** равен 5. У пользователя может быть пять открытых подключений по запросу, в то время как учетная запись службы может иметь пять одновременных подключений опрашивающей отправки к почтовому ящику пользователя одновременно с пользователем.

- В следующей таблице показано, как рассчитываются бюджеты регулирования **евсмакссубскриптионс** между учетной записью службы и учетной записью для олицетворения.

   **Таблица 2: бюджетный учет Евсмакссубскриптионс**

   |**Версия Exchange**|**Евсмакссубскриптионс регулирование бюджетного учета**|
   |:-----|:-----|
   |Exchange Online  <br/> |Выставление счета для целевого почтового ящика.  <br/> |
   |Exchange 2013  <br/> |Выставление счета для целевого почтового ящика.  <br/> |
   |Exchange 2010 SP3  <br/> |Выставление счета для целевого почтового ящика.  <br/> |
   |Exchange 2010 с пакетом обновления 2 (SP2)  <br/> |Оплачиваются по учетной записи звонка. Начиная с Exchange 2010 с пакетом обновления 2 (SP2) RU4, бюджет расставляется в соответствии с целевым почтовым ящиком.  <br/> |
   |Exchange 2010 с пакетом обновления 1 (SP1)  <br/> |Оплачиваются по учетной записи звонка.  <br/> |
   |Exchange 2010  <br/> |Оплачиваются по учетной записи звонка.  <br/> |

- Так как бюджет регулирования **евсмакссубскриптионс** задается для олицетворения учетной записи, ограничение числа почтовых ящиков, на которые может подписаться учетная запись службы и получения потоковых уведомлений, при условии, что используется олицетворение, не ограничено. Для олицетворения учетной записи не может быть более _n_ одновременных запросов на один целевой почтовый ящик, где _n_ — значение **евсмакссубскриптионс** . Если вы не используете олицетворение, то в одной и той же учетной записи службы не может быть больше _n_ групповых одновременных запросов. Таким образом, сделать вывод заключается в том, что использование олицетворения для учетной записи службы позволяет экспоненциально увеличить количество почтовых ящиков, которые можно обслуживать. Более подробную информацию можно узнать [в статье поддержание сходства между группой подписок и сервером почтовых ящиков в Exchange](how-to-maintain-affinity-between-group-of-subscriptions-and-mailbox-server.md).

- Параметры политики **евсперценттимеинмаилбоксрпк**, **EWSPercentTimeInCAS**и **евсперценттимеинад** ссылаются на действия, выполняемые одним потоком. Если приложение выполняет несколько параллельных операций, следует учитывать совокупный объем этих операций в бюджете ресурсов пользователя.

## <a name="throttling-implications-for-ews-batch-requests"></a>Влияние регулирования на пакетные запросы EWS

С помощью веб-служб Exchange вы можете выполнить пакетные запросы к нескольким элементам в один запрос, выполняемый сервером клиентского доступа. Это позволяет повысить эффективность и производительность. Когда сервер Exchange Server выполняет пакетный запрос, он проверяет бюджет пользователя после выполнения каждого элемента в пакете. Если приложение превышает бюджет, обработка следующего элемента в пакете задерживается до тех пор, пока не будет оплачен бюджет для этого пользователя. Чтобы обеспечить успешную работу приложений, использующих пакетные операции, ограничьте количество запросов элементов, которые могут быть включены в один пакет, и разделите большие пакеты на несколько небольших пакетов, чтобы повысить надежность результатов. Действие пакетной операции в определенных пороговых значениях регулирования зависит от типа запроса, размера обрабатываемых элементов (например, в операциях **UploadItems** или **ExportItems** ) и содержимого почтового ящика. Политики регулирования влияют на пакетные операции, вызывая более длительную обработку запроса. Таким образом, вызывающий абонент должен ждать ответа, и, так как EWS ограничит время выполнения пакетного запроса на одну минуту, время ожидания вызова может истечет.

Чтобы определить оптимальный размер пакета для приложения, выполните модульное тестирование с использованием различных входных наборов, чтобы приложение не выполняло какие – либо ошибки в рабочей среде.

## <a name="throttling-policy-parameters-that-affect-ews-search-operations"></a>Параметры политики регулирования, которые влияют на поисковые операции EWS

[Операции поиска в EWS](search-and-ews-in-exchange.md) могут занимать много времени и ресурсов в зависимости от того, как выполняется поиск и какие сведения запрашиваются. Для управления использованием ресурсов во время поиска применяются два параметра политики: **евсфастсеарчтимеаутинсекондс** и **евсфиндкаунтлимит**.

Параметр политики **евсфастсеарчтимеаутинсекондс** указывает время (в секундах), в течение которого поиск службы EWS (также называется поиском по индексированию содержимого) выполняется до истечения времени ожидания. Быстрый поиск — это поиск, выполненный с помощью строки запроса расширенного синтаксиса запросов (AQS) в [операции FindItem](https://msdn.microsoft.com/library/ebad6aae-16e7-44de-ae63-a95b24539729%28Office.15%29.aspx).

Вы можете выполнить поиск в папке почтового ящика Exchange двумя способами:

- С помощью поиска в хранилище Exchange, который выполняет последовательный просмотр всех сообщений в целевой области поиска.

- С помощью службы поиска Exchange (индексирование контента).

Оба эти типа поиска могут привести к превышению времени ожидания. По возможности используйте службу поиска Exchange, так как эти операции поиска часто предназначены для индексов почтовых ящиков и используют запросы AQS. В приведенном ниже примере показано, как выполнить поиск AQS в папке "Входящие" с помощью EWS и службы поиска Exchange.

```cs
ItemView iv = new ItemView(1000);
FindItemsResults<Item> fiitems = service.FindItems(WellKnownFolderName.Inbox, "subject:football", iv);
```

Если вы не можете использовать поиск AQS, старайтесь не использовать слишком сложные фильтры поиска. Кроме того, старайтесь не создавать фильтры поиска на основе вычисляемых значений, если запрос включает расширенные свойства MAPI. Служба поиска AQS была введена в Exchange 2010.

> [!NOTE]
> При первом запуске сложного поискового запроса в хранилище Exchange он выполняется очень медленно и может исполняться. После этого запрос ответит быстрее. Для получения дополнительных сведений о внутренних процессах Exchange Server, происходящих во время поисковых запросов в хранилище Exchange, ознакомьтесь со статьей [о влиянии на производительность при высоком количестве элементов и ограниченных представлениях](https://technet.microsoft.com/library/cc535025%28EXCHG.80%29.aspx) на сайте TechNet. С помощью **SearchFilter** создается динамическое ограничение, которое помогает аналогичным запросам в будущем, но так как эти ограничения являются динамическими, они не являются постоянными и не являются надежными и удаляются по истечении максимум в три дня.

Параметр политики **евсфиндкаунтлимит** указывает максимальное количество элементов из результатов операции **FindItem** или **FindFolder** , которые могут существовать в памяти на сервере клиентского доступа одновременно для одного пользователя. Каждый элемент или папка, которые EWS обрабатывает в запросе **FindItem** или **FindFolder** , учитываются в бюджете, указанном в элементе **евсфиндкаунтлимит** . Когда ответ отправляется обратно инициатору запроса, отменяется зарядка по количеству операций поиска для текущего вызова. Ответ, который сервер возвращает запрашивающему участнику при превышении бюджета, основан на значении элемента **рекуестсерверверсион** и о том, указан ли в запросе постраничный просмотр. Когда значение элемента **рекуестсерверверсион** указывает Exchange 2010 или более ранняя версия Exchange, сервер отправляет ответ об ошибке с кодом ошибки **еррорсервербуси**. Если значение элемента **рекуестсерверверсион** указывает версию Exchange, начинающуюся с Exchange 2010 с пакетом обновления 1 (SP1) или Exchange Online, а клиент использует разбиение на страницы, EWS может вернуть частичный результирующий набор вместо ошибки. Ваше приложение должно ожидать, что EWS не сможет вернуть все элементы. Если для элемента **инклудесластитеминранже** задано значение false, приложение должно выполнить другой запрос **FindItem** или **FindFolder** с новым смещением и продолжить до тех пор, пока элемент **инклудесластитеминранже** не возвратит значение true.

При использовании операции **FindItem** или **FindFolder** важно использовать разбиение по страницам. Управляемый API EWS использует разбиение по страницам, но если вы используете другие методы, такие как прокси-объекты EWS или необработанные SOAP, необходимо явно задать разбиение по страницам. В приведенном ниже примере показано, как использовать разбиение по страницам в управляемом API EWS.

```cs
ItemView iv = new ItemView(1000);
FindItemsResults<Item> fiFindItemResults = service.FindItems(WellKnownFolderName.Inbox, iv);
```

> [!NOTE]
> Политика по умолчанию в Exchange позволяет ограничить размер страницы 1000 элементами. Установка для размера страницы значения, которое больше, чем это значение, не оказывает никакого практического действия.

Приложения также должны учитывать факт того, что значение параметра регулирования _евсфиндкаунтлимит_ может привести к возврату частичного набора результатов для приложений, которые выполняют параллельные запросы. В приведенном ниже примере показано, как использовать свойство **мореаваилабле** в УПРАВЛЯЕМОМ API EWS, чтобы убедиться, что все результаты включены в запрос.

```cs
ItemView iv = new ItemView(1000);
service.TraceEnabled = false;
FindItemsResults<Item> fiResults = null;
Do
{
    fiResults = service.FindItems(WellKnownFolderName.Inbox, iv);
    PropertySet itItemPropSet = new PropertySet(BasePropertySet.IdOnly) { EmailMessageSchema.Body };
    //Process Items in Result Set
    iv.Offset += fiResults.Items.Count;
}
while (fiResults.MoreAvailable == true);
```

## <a name="throttling-policies-and-concurrency"></a>Политики регулирования и параллелизм

Параллелизм — это количество подключений от определенного пользователя. Соединение удерживается с момента получения запроса, пока не будет отправлен ответ инициатору запроса. Если пользователи пытаются сделать более параллельные запросы, чем разрешено политикой, новая попытка подключения завершается неудачно. Однако существующие соединения остаются действительными. Политики регулирования могут повлиять на параллелизм несколькими различными способами.

Параметр политики регулирования **евсмаксконкурренци** задает количество одновременных подключений, которые определенный пользователь может использовать на сервере Exchange одновременно. Чтобы определить максимальное число одновременных подключений, примите во внимание подключения, которые будут использоваться клиентами Outlook. Outlook 2007 и Outlook 2010 используют EWS для доступа к сведениям о доступности и отсутствии на работе (отсутствие на работе). В Outlook 2011 для всех функций клиентского доступа используется EWS. В зависимости от количества клиентов Outlook, которые активно подключаются к почтовому ящику пользователя, число одновременных подключений, доступных пользователю, может быть ограничено. Кроме того, если ваше приложение должно подключаться к нескольким почтовым ящикам одновременно с одним контекстом безопасности, необходимо учитывать значение политики **евсмаксконкурренци** . Дополнительные сведения об использовании единого контекста безопасности с одновременными подключениями приведены в статье [регулирование требований для приложений, использующих олицетворение EWS](#throttling-considerations-for-applications-that-use-ews-impersonation) ранее в этой статье.

Приложения, которые одновременно подключаются к нескольким почтовым ящикам, должны иметь возможность отслеживать использование ресурсов на стороне клиента. Так как операции EWS основаны на запросах и ответах, вы можете убедиться, что ваши приложения хорошо работают в пороговом значении **евсмаксконкурренци** , отслеживая число подключений между началом запроса и при получении ответа и обеспечение того, что не более десяти открытых запросов выполняются одновременно.

Параметр политики **евсфиндкаунтлимит** указывает максимальный размер результата, который может использовать операция **FindItem** или **FindFolder** для сервера клиентского доступа одновременно для одного пользователя. Если приложение (или потенциально несколько приложений) выполняет два одновременных запроса **FindItem** для служб EWS, которые возвращают 100 элементов для определенного пользователя, **евсфиндкаунтлимит** начисление по бюджету конкретного пользователя будет 200. Когда первый запрос возвращается, бюджет перепадает до 100 и при возвращении второго запроса бюджет передается в ноль. Если одно и то же приложение должно выполнить два одновременных запроса для элементов 1000, то значение бюджета будет 2000 элементов, что превышает значение **евсфиндкаунтлимит** . Если для элементов в бюджете пользователя меньше нуля, следующий запрос приводит к ошибке, пока бюджет пользователя не перейдет в один или несколько.

## <a name="throttling-considerations-for-ews-notification-applications"></a>Вопросы регулирования для приложений уведомлений EWS

Если вы создаете приложения уведомлений EWS, которые используют Уведомления Push, Pull или Streaming, следует учитывать последствия **евсмакссубскриптионс** и политик регулирования **евсмаксконкурренци** и **хангингконнектионлимит**.

Параметр политики **евсмакссубскриптионс** указывает максимальное количество активных почтовых подписок, а также почтовых подписок, которые пользователь может иметь на определенном сервере клиентского доступа одновременно. Для разных версий Exchange для этого параметра заданы разные значения по умолчанию. Пользователь может подписаться на все папки в почтовом ящике с помощью свойства **субскрибетоаллфолдерс** , в котором используется одна подписка на бюджете **евсмакссубскриптионс** . Пользователи могут подписываться на отдельные папки, при этом каждая подписка на эту папку подсчитывается в соответствии с бюджетом **евсмакссубскриптионс** , вплоть до предельного значения параметра **евсмакссубскриптионс** (например, пользователи могут подписываться на 20 папок календаря в разных почтовых ящиках, если для **евсмакссубскриптионс** установлено значение 20).

Сведения об олицетворении и параметре **евсмакссубскриптионс** приведены в статье [регулирование требований для приложений, использующих олицетворение EWS](#throttling-considerations-for-applications-that-use-ews-impersonation) ранее в этой статье.

Параметр политики **евсмаксконкурренци** также может быть вопросом для уведомлений EWS; Например:

- При увеличении числа подключений для владельца подписки с помощью службы EWS при создании уведомления с помощью принудительной подписки.

- Если приложение предназначено для прослушивания почтовых ящиков нескольких пользователей, а пользователи получают одновременные уведомления для экземпляра сообщения, отправляемого в список рассылки.

Если приложение уведомления является многопотоковым и создает одновременные запросы на подключение для получения дополнительных сведений о конкретном сообщении, которое было получено учетной записью пользователя, ограничение политики **евсмаксконкурренци** может быть превышено. Для этого следует рассмотреть возможность мониторинга параллельных подключений в приложении, в том числе тех, которые могут использоваться сервером, и реализации очереди запросов на клиенте.

**Хангингконнектионлимит** применяется только к потоковым уведомлениям. Это значение задается в файле web.config, что означает, что администратор Exchange может задать это значение на локальном сервере Exchange Server, но почтовые ящики Exchange Online должны использовать значение по умолчанию для этого ограничения, равное 10 для Exchange Online, Exchange 2019, Exchange 2016 и 3 для Exchange 2013. Чтобы узнать больше, посмотрите, [какие значения регулирования необходимо учитывать?](how-to-maintain-affinity-between-group-of-subscriptions-and-mailbox-server.md#bk_throttling).

## <a name="throttling-policy-and-application-performance"></a>Политика регулирования и производительность приложения

Следующие три параметра политики регулирования **перценттимеин** влияют на время, в течение которого приложение EWS может использовать сервер клиентского доступа.

- **евсперценттимеинад**

- **EWSPercentTimeInCAS**

- **евсперценттимеинмаилбоксрпк**

Значения, указанные в параметрах политики **перценттимеин** , указывают время, в течение которого выделяется один поток. Например, при наличии значения **EWSPercentTimeInCAS** 90, если процесс выполняет два параллельных запроса, которые тратят 54 секунд на выполнение кода на сервере клиентского доступа, процесс использует значение 108 секунды в окне 60 second. Представляет значение параметра **EWSPercentTimeInCAS** , равное 180 процентов.

> [!NOTE]
> Значение параметра **EWSPercentTimeInCAS** является перекрытием надмножеством значений параметров **евсперценттимеинад** и **евсперценттимеинмаилбоксрпк** . Это означает, что расход времени обработки сервера клиентского доступа всегда будет превышать расходы в **евсперценттимеинад** и **евсперценттимеинмаилбоксрпк**. Это связано с тем, что для того, чтобы компонент Exchange выполнял вызов Active Directory или RPC, он должен уже иметь код сервера клиентского доступа. Кроме того, при выполнении вызовов LDAP или RPC расход времени на обработку для **EWSPercentTimeInCAS** не прекращается. Несмотря на то, что запрос может синхронно ожидать ответа от доменных служб Active Directory (AD DS) или хранилища Exchange, процесс по-прежнему использует поток на сервере, поэтому поток должен по-прежнему платить за это использование.

Время ЦП, которое может пройти приложение в течение 60 секунды, может превышать эти ограничения. Поэтому важно учитывать объем и тип выполняемых запросов. Например, большой пакет операций **ResolveNames** , выполняемых одновременно, может превышать значение параметра политики **евсперценттимеинад** . Значения политики, которые входят в политику регулирования по умолчанию, предназначены для того, чтобы большинство приложений EWS работали без выпусков; Однако когда многопоточные приложения с большим количеством томов размещают большой объем запросов на одном сервере клиентского доступа, это может создать проблемы. Чтобы избежать этого, рассмотрите возможность ограничения размера пакетов, которые будут выполняться на сервере.

## <a name="throttling-policies-and-applications-that-send-a-large-volume-of-email"></a>Регулирование политик и приложений, отправляющих большой объем электронной почты

Политики регулирования по умолчанию включают три параметра политики ограничения скорости, которые могут повлиять на приложения, которые используют EWS для отправки большого объема сообщений или отправки сообщений в больших пакетах в течение короткого периода времени.

> [!NOTE]
> Как правило, не рекомендуется использовать EWS для отправки массовых сообщений электронной почты. Используйте узел SMTP, который специализируется на службах массовой почты для отправки часто встречающихся больших сообщений электронной почты.

Параметр политики **MessageRateLimit** указывает количество сообщений в минуту, которые могут быть отправлены любым клиентом Exchange, в том числе EWS. По умолчанию для этой политики задано 30 сообщений в минуту. Для обычных пользователей это, как правило, достаточно. Однако приложения, которые отправляют большие пакеты сообщений электронной почты, например часть программы для выставления счетов, могут выполнять проблемы. При превышении этого ограничения доставка сообщений для почтового ящика задерживается. В частности, сообщения будут отображаться в папке "Исходящие" или "Черновики" в течение более длительных периодов времени, когда пользователь или приложение отправит большее количество сообщений, чем значение, заданное параметром **MessageRateLimit** . Это необходимо учитывать при разработке системы отслеживания доставки, особенно если ваше приложение использует почтовый ящик, к которому пользователи подключаются с помощью Outlook. Если отложенные элементы хранятся в папке "Исходящие" или "Черновики", пользователи могут интерпретировать сообщение об ошибке.

Параметр политики **RecipientRateLimit** указывает предельное число получателей, которые пользователь может иметь в течение 24 часов. Например, если задано значение 500, это означает, что одна учетная запись почтового ящика Exchange может отправлять сообщения не более чем 500 получателям каждый день. Это значение применяется к сообщениям получателям, находящимся внутри организации и за ее пределами. Это значение по умолчанию может вызывать проблемы для некоторых бизнес-приложений, выполняемых в течение конца месяца и требующих отправки сообщений больше, чем это количество получателей. Для обхода этого ограничения можно использовать внешние службы, которые обеспечивают пакетную обработку сообщений или отдельные решения для исходящей ретрансляции.

Параметр политики **форвардилимит** указывает максимальное количество получателей, на которые сообщения могут пересылаться или перенаправляться с помощью правил для папки "Входящие". Этот параметр не ограничивает количество сообщений, которые могут быть перенаправлены или перенаправлены получателям.

## <a name="errors-generated-when-throttling-limits-are-exceeded"></a>Ошибки, возникающие при превышении ограничений регулирования

При превышении политик регулирования, EWS создает одну из ошибок, перечисленных в следующей таблице.

**Таблица 3: ошибки ограничения регулирования**

|**Error**|**Параметр политики регулирования**|**Описание**|
|:-----|:-----|:-----|
|еррорексцеедедконнектионкаунт  <br/> |**евсмаксконкурренци** <br/> |Указывает на то, что существует больше параллельных запросов к серверу, чем разрешено политикой пользователя.  <br/> |
|еррорексцеедедсубскриптионкаунт  <br/> |**евсмакссубскриптионс** <br/> |Указывает, что превышено максимальное число подписок для политики регулирования пользователя.  <br/> |
|еррорексцеедедфиндкаунтлимит  <br/> |**евсфиндкаунтлимит** <br/> |Указывает, что вызов операции поиска превысил общее количество элементов, которые могут быть возвращены.  <br/> |
|еррорсервербуси  <br/> |**Евсперценттимеинмаилбоксрпк**         **EWSPercentTimeInCAS**         **евсперценттимеинад** <br/> |Происходит, когда сервер занят. Значение Баккоффмиллисекондс, возвращаемое с ошибками Еррорсервербуси, указывает клиенту на время ожидания, пока не будет повторно отправлен запрос, вызвавший ответ, который возвращал этот код ошибки.  <br/> |

В следующей таблице перечислены коды состояния HTTP, которые возвращаются ошибками регулирования.

**Таблица 4: коды состояния HTTP, возвращаемые ошибками регулирования**

|**Код состояния HTTP**|**Описание**|
|:-----|:-----|
|HTTP 503  <br/> |Указывает, что запросы EWS помещаются в очередь с IIS. Клиент должен отложить отправку дополнительных запросов до следующего времени.  <br/> |
|HTTP 500  <br/> |Указывает на внутреннюю ошибку сервера с кодом ошибки Еррорсервербуси. Это указывает на то, что клиент должен отложить отправку дополнительных запросов до следующего времени. Ответ может содержать подсказку обратной передачи с именем Баккоффмиллисекондс. Если этот параметр задан, значение Баккоффмиллисекондс должно использоваться в качестве срока действия до тех пор, пока клиент не повторно выдает запрос.  <br/> |
|HTTP 200  <br/> |Содержит ответ на ошибку на основе схемы EWS с кодом ошибки Ерроринтерналсервереррор. Может присутствовать внутренний код ошибки Еррорсервербуси. Это указывает на то, что клиент должен отложить отправку дополнительных запросов до следующего времени.  <br/> |

## <a name="see-also"></a>См. также

- [Управление рабочей нагрузкой Exchange](https://technet.microsoft.com/library/jj150503.aspx)
- [Командлет New – ThrottlingPolicy](https://technet.microsoft.com/library/dd351045.aspx)
- [Общие сведения о политиках регулирования клиентов](https://technet.microsoft.com/library/dd297964.aspx)
- [Класс ThrottlingPolicy](https://msdn.microsoft.com/library/ff342496%28v=EXCHG.140%29.aspx)
- [Политики регулирования и Евсфиндкаунтлимит](https://blogs.msdn.com/b/exchangedev/archive/2010/03/12/throttling-policies-and-the-ewsfindcountlimit.aspx)
- [Моментальные снимки бюджета в журналах IIS](https://blogs.msdn.com/b/exchangedev/archive/2010/03/10/budget-snapshots-in-the-iis-logs.aspx)

- [Влияние регулирования на развертывание в Exchange 2010 с пакетом обновления 1 (SP1)](http://msexchangeteam.com/archive/2010/08/27/456040.aspx)
- [Связи политик регулирования в Exchange 2010 с пакетом обновления 1 (SP1)](http://msexchangeteam.com/archive/2010/08/02/455707.aspx)
- [Политики регулирования и Кпустартперцент](https://blogs.msdn.com/b/exchangedev/archive/2010/03/11/throttling-policies-and-cpustartpercent.aspx)
- [Олицетворение и EWS в Exchange](impersonation-and-ews-in-exchange.md)
